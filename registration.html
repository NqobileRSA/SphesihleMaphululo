<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registration - Latter Glory Day Care</title>
    <style>
      .registration-section {
        padding: 4rem 0;
        background-color: #f8f9fa;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
      }
      .progress-bar {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 3rem;
      }
      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
      }
      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e0e0e0;
        color: #666;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }
      .step.active .step-number {
        background-color: #ff6b6b;
        color: white;
      }
      .step-text {
        font-size: 0.875rem;
        color: #666;
      }
      .step.active .step-text {
        color: #ff6b6b;
      }
      .progress-line {
        flex: 1;
        height: 2px;
        background-color: #e0e0e0;
        margin: 0 1rem;
        margin-bottom: 1.5rem;
      }
      .registration-form {
        background-color: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
      }
      .registration-form.active {
        display: block;
      }
      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #333;
        font-weight: 500;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
      }
      .form-group textarea {
        height: 100px;
        resize: vertical;
      }
      .form-buttons {
        margin-top: 2rem;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
      }
      .next-btn,
      .back-btn,
      .submit-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 30px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .next-btn,
      .submit-btn {
        background-color: #ff6b6b;
        color: white;
      }
      .back-btn {
        background-color: #e0e0e0;
        color: #666;
      }
      .next-btn:hover,
      .submit-btn:hover {
        background-color: #ff5252;
        transform: translateY(-2px);
      }
      .back-btn:hover {
        background-color: #d4d4d4;
        transform: translateY(-2px);
      }
      .payment-amount {
        grid-column: 1 / -1;
        text-align: center;
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
      }
      .fee-amount {
        font-size: 2rem;
        color: #ff6b6b;
        font-weight: bold;
        margin: 0.5rem 0;
      }
      .full-width {
        grid-column: 1 / -1;
      }
      .payment-instructions {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
      }
      .bank-details {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
      }
      .bank-details p {
        margin: 0.5rem 0;
      }
      .error {
        border-color: #dc3545 !important;
      }
      .error-message {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }
      @media screen and (max-width: 768px) {
        .form-grid {
          grid-template-columns: 1fr;
        }
        .progress-bar {
          flex-direction: column;
          gap: 1rem;
        }
        .progress-line {
          width: 2px;
          height: 20px;
          margin: 0;
        }
      }
    </style>
  </head>
  <body>
    <section class="registration-section">
      <div class="container">
        <div class="progress-bar">
          <div class="step active">
            <span class="step-number">1</span>
            <span class="step-text">Parent Information</span>
          </div>
          <div class="progress-line"></div>
          <div class="step">
            <span class="step-number">2</span>
            <span class="step-text">Child Information</span>
          </div>
          <div class="progress-line"></div>
          <div class="step">
            <span class="step-number">3</span>
            <span class="step-text">Payment</span>
          </div>
        </div>

        <form id="registrationForm">
          <!-- Parent Information -->
          <div id="parentForm" class="registration-form active">
            <h3>Parent/Guardian Information</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="parentFirstName">First Name *</label>
                <input
                  type="text"
                  id="parentFirstName"
                  name="parentFirstName"
                  required
                />
                <div class="error-message"></div>
              </div>
              <div class="form-group">
                <label for="parentLastName">Last Name *</label>
                <input
                  type="text"
                  id="parentLastName"
                  name="parentLastName"
                  required
                />
                <div class="error-message"></div>
              </div>
              <div class="form-group">
                <label for="parentID">ID Number *</label>
                <input
                  type="text"
                  id="parentID"
                  name="parentID"
                  required
                  pattern="\d*"
                />
                <div class="error-message"></div>
              </div>
              <div class="form-group">
                <label for="parentEmail">Email *</label>
                <input
                  type="email"
                  id="parentEmail"
                  name="parentEmail"
                  required
                />
                <div class="error-message"></div>
              </div>
              <div class="form-group">
                <label for="parentPhone">Phone *</label>
                <input
                  type="tel"
                  id="parentPhone"
                  name="parentPhone"
                  required
                />
                <div class="error-message"></div>
              </div>
              <div class="form-group">
                <label for="parentAddress">Address *</label>
                <textarea
                  id="parentAddress"
                  name="parentAddress"
                  required
                ></textarea>
                <div class="error-message"></div>
              </div>
              <div class="form-group">
                <label for="emergencyContact">Emergency Contact *</label>
                <input
                  type="text"
                  id="emergencyContact"
                  name="emergencyContact"
                  required
                />
                <div class="error-message"></div>
              </div>
              <div class="form-group">
                <label for="emergencyPhone">Emergency Contact Number *</label>
                <input
                  type="tel"
                  id="emergencyPhone"
                  name="emergencyPhone"
                  required
                />
                <div class="error-message"></div>
              </div>
            </div>
            <div class="form-buttons">
              <button type="button" class="next-btn" onclick="nextStep(1)">
                Next Step
              </button>
            </div>
          </div>

          <!-- Child Information -->
          <div id="childForm" class="registration-form">
            <h3>Child Information</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="childFirstName">First Name *</label>
                <input
                  type="text"
                  id="childFirstName"
                  name="childFirstName"
                  required
                />
                <div class="error-message"></div>
              </div>
              <div class="form-group">
                <label for="childLastName">Last Name *</label>
                <input
                  type="text"
                  id="childLastName"
                  name="childLastName"
                  required
                />
                <div class="error-message"></div>
              </div>
              <div class="form-group">
                <label for="dateOfBirth">Date of Birth *</label>
                <input
                  type="date"
                  id="dateOfBirth"
                  name="dateOfBirth"
                  required
                />
                <div class="error-message"></div>
              </div>
              <div class="form-group">
                <label for="gender">Gender *</label>
                <select id="gender" name="gender" required>
                  <option value="">Select Gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
                <div class="error-message"></div>
              </div>
              <div class="form-group">
                <label for="program">Program *</label>
                <select id="program" name="program" required>
                  <option value="">Select Program</option>
                  <option value="infant">Infant Care</option>
                  <option value="toddler">Toddler</option>
                  <option value="preschool">Preschool</option>
                  <option value="gradeR">Grade R</option>
                </select>
                <div class="error-message"></div>
              </div>
              <div class="form-group">
                <label for="medicalConditions">Medical Conditions</label>
                <textarea
                  id="medicalConditions"
                  name="medicalConditions"
                ></textarea>
              </div>
              <div class="form-group">
                <label for="allergies">Allergies</label>
                <textarea id="allergies" name="allergies"></textarea>
              </div>
              <div class="form-group">
                <label for="medications">Medications</label>
                <textarea id="medications" name="medications"></textarea>
              </div>
            </div>
            <div class="form-buttons">
              <button type="button" class="back-btn" onclick="previousStep(2)">
                Previous Step
              </button>
              <button type="button" class="next-btn" onclick="nextStep(2)">
                Next Step
              </button>
            </div>
          </div>

          <!-- Payment Information -->
          <div id="paymentForm" class="registration-form">
            <h3>Payment</h3>
            <div class="form-grid">
              <div class="form-group payment-amount">
                <h4>Registration Fee</h4>
                <p class="fee-amount">R50</p>
              </div>

              <div class="form-group full-width">
                <div class="payment-instructions">
                  <h4>Payment Instructions:</h4>
                  <p>
                    Please make a payment to our bank account and upload the
                    proof of payment below.
                  </p>
                </div>

                <div class="bank-details">
                  <h4>Bank Details:</h4>
                  <p>Bank Name: Standard Bank</p>
                  <p>Account Name: Latter Glory Day Care</p>
                  <p>Account Number: 1234567890</p>
                  <p>Branch Code: 051001</p>
                  <p>Reference: LGDC_[Child's Name]</p>
                </div>
              </div>

              <div class="form-group full-width">
                <label for="proofOfPayment">Upload Proof of Payment *</label>
                <input
                  type="file"
                  id="proofOfPayment"
                  name="proofOfPayment"
                  accept=".pdf,.jpg,.jpeg,.png"
                  required
                />
                <div class="error-message"></div>
              </div>
            </div>
            <div class="form-buttons">
              <button type="button" class="back-btn" onclick="previousStep(3)">
                Previous Step
              </button>
              <button type="submit" class="submit-btn">
                Complete Registration
              </button>
            </div>
          </div>
        </form>
      </div>
    </section>

    <script>
      // Form navigation and validation
      let currentStep = 1;
      const forms = {
        1: document.getElementById('parentForm'),
        2: document.getElementById('childForm'),
        3: document.getElementById('paymentForm'),
      };

      function showStep(step) {
        Object.values(forms).forEach((form) => form.classList.remove('active'));
        forms[step].classList.add('active');

        // Update progress bar
        document.querySelectorAll('.step').forEach((stepEl, index) => {
          if (index + 1 <= step) {
            stepEl.classList.add('active');
          } else {
            stepEl.classList.remove('active');
          }
        });
      }

      function validateStep(step) {
        const currentForm = forms[step];
        const requiredFields = currentForm.querySelectorAll('[required]');
        let isValid = true;

        requiredFields.forEach((field) => {
          const errorMessage = field.nextElementSibling;
          if (!field.value.trim()) {
            isValid = false;
            field.classList.add('error');
            errorMessage.textContent = 'This field is required';
          } else {
            field.classList.remove('error');
            errorMessage.textContent = '';
          }
        });

        return isValid;
      }

      function nextStep(currentStepNumber) {
        if (validateStep(currentStepNumber)) {
          currentStep = currentStepNumber + 1;
          showStep(currentStep);
          window.scrollTo(0, 0);
        }
      }

      function previousStep(currentStepNumber) {
        currentStep = currentStepNumber - 1;
        showStep(currentStep);
        window.scrollTo(0, 0);
      }

      // Updated form submission with MongoDB integration
      document
        .getElementById('registrationForm')
        .addEventListener('submit', async function (e) {
          e.preventDefault();

          if (!validateStep(3)) {
            return;
          }

          const submitButton = document.querySelector('.submit-btn');
          submitButton.disabled = true;
          submitButton.textContent = 'Processing...';

          try {
            const formData = new FormData();

            // Handle file upload
            const fileInput = document.getElementById('proofOfPayment');
            const file = fileInput.files[0];
            formData.append('proofOfPayment', file);

            // Prepare parent data
            const parentData = {
              firstName: document.getElementById('parentFirstName').value,
              lastName: document.getElementById('parentLastName').value,
              idNumber: document.getElementById('parentID').value,
              email: document.getElementById('parentEmail').value,
              phone: document.getElementById('parentPhone').value,
              address: document.getElementById('parentAddress').value,
              emergencyContact: {
                name: document.getElementById('emergencyContact').value,
                phone: document.getElementById('emergencyPhone').value,
              },
            };
            formData.append('parent', JSON.stringify(parentData));

            // Prepare child data
            const childData = {
              firstName: document.getElementById('childFirstName').value,
              lastName: document.getElementById('childLastName').value,
              dateOfBirth: document.getElementById('dateOfBirth').value,
              gender: document.getElementById('gender').value,
              program: document.getElementById('program').value,
              medicalInfo: {
                conditions: document.getElementById('medicalConditions').value,
                allergies: document.getElementById('allergies').value,
                medications: document.getElementById('medications').value,
              },
            };
            formData.append('child', JSON.stringify(childData));

            // Send to MongoDB backend
            const response = await fetch('http://localhost:3000/api/register', {
              method: 'POST',
              body: formData,
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
              // Show success message before redirect
              const successMessage = document.createElement('div');
              successMessage.className = 'success-message';
              successMessage.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #4CAF50;
        color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
        z-index: 1000;
      `;
              successMessage.textContent =
                'Registration successful! Redirecting...';
              document.body.appendChild(successMessage);

              // Redirect after showing success message
              setTimeout(() => {
                window.location.href = '/registration-success.html';
              }, 2000);
            } else {
              throw new Error(result.message || 'Registration failed');
            }
          } catch (error) {
            console.error('Error:', error);

            // Show error message to user
            const errorElement = document.querySelector(
              '#paymentForm .error-message'
            );
            errorElement.textContent =
              error.message ||
              'There was an error processing your registration. Please try again.';
            errorElement.style.cssText = `
      background-color: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    `;

            // Re-enable submit button
            submitButton.disabled = false;
            submitButton.textContent = 'Complete Registration';
          }
        });

      // All existing validation functions remain the same
      function validatePhoneNumber(input) {
        const phoneRegex = /^\+?\d{10,12}$/;
        const errorMessage = input.nextElementSibling;

        if (!phoneRegex.test(input.value)) {
          input.classList.add('error');
          errorMessage.textContent = 'Please enter a valid phone number';
        } else {
          input.classList.remove('error');
          errorMessage.textContent = '';
        }
      }

      function validateEmail(input) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const errorMessage = input.nextElementSibling;

        if (!emailRegex.test(input.value)) {
          input.classList.add('error');
          errorMessage.textContent = 'Please enter a valid email address';
        } else {
          input.classList.remove('error');
          errorMessage.textContent = '';
        }
      }

      function validateIDNumber(input) {
        const errorMessage = input.nextElementSibling;

        if (input.value.length !== 13) {
          input.classList.add('error');
          errorMessage.textContent = 'ID number must be 13 digits';
        } else {
          input.classList.remove('error');
          errorMessage.textContent = '';
        }
      }

      function validateFileUpload(input) {
        const errorMessage = input.nextElementSibling;
        const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
        const maxSize = 5 * 1024 * 1024; // 5MB

        if (!input.files || !input.files[0]) {
          input.classList.add('error');
          errorMessage.textContent = 'Please select a file';
          return false;
        }

        const file = input.files[0];

        if (!allowedTypes.includes(file.type)) {
          input.classList.add('error');
          errorMessage.textContent = 'Please upload a PDF, JPG, or PNG file';
          return false;
        }

        if (file.size > maxSize) {
          input.classList.add('error');
          errorMessage.textContent = 'File size must be less than 5MB';
          return false;
        }

        input.classList.remove('error');
        errorMessage.textContent = '';
        return true;
      }

      // Initialize event listeners
      document.addEventListener('DOMContentLoaded', function () {
        // Phone number validation
        document
          .getElementById('parentPhone')
          .addEventListener('input', function (e) {
            this.value = this.value.replace(/[^\d+]/g, '');
            validatePhoneNumber(this);
          });

        document
          .getElementById('emergencyPhone')
          .addEventListener('input', function (e) {
            this.value = this.value.replace(/[^\d+]/g, '');
            validatePhoneNumber(this);
          });

        // ID number validation
        document
          .getElementById('parentID')
          .addEventListener('input', function (e) {
            this.value = this.value.replace(/[^\d]/g, '');
            validateIDNumber(this);
          });

        // Email validation
        document
          .getElementById('parentEmail')
          .addEventListener('input', function (e) {
            validateEmail(this);
          });

        // File upload validation
        document
          .getElementById('proofOfPayment')
          .addEventListener('change', function (e) {
            validateFileUpload(this);
          });

        // Date of birth validation
        const dateOfBirth = document.getElementById('dateOfBirth');
        const today = new Date().toISOString().split('T')[0];
        dateOfBirth.setAttribute('max', today);

        dateOfBirth.addEventListener('change', function (e) {
          const today = new Date();
          const birthDate = new Date(this.value);
          const age = today.getFullYear() - birthDate.getFullYear();
          const errorMessage = this.nextElementSibling;

          if (age > 6) {
            this.classList.add('error');
            errorMessage.textContent = 'Child must be 6 years or younger';
          } else if (birthDate > today) {
            this.classList.add('error');
            errorMessage.textContent = 'Date cannot be in the future';
          } else {
            this.classList.remove('error');
            errorMessage.textContent = '';
          }
        });
      });
    </script>
  </body>
</html>
